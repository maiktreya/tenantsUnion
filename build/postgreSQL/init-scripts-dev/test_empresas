CREATE TABLE staging_empresas (
    nombre TEXT,
    cif_nif_nie TEXT,
    entramado TEXT,
    directivos TEXT,
    api TEXT,
    direccion_fiscal TEXT,
    col_extra_1 TEXT,
    col_extra_2 TEXT,
    col_extra_3 TEXT,
    col_extra_4 TEXT,
    col_extra_5 TEXT,
    col_extra_6 TEXT
);

COPY staging_empresas
FROM '/csv-data/Empresas.csv'
WITH (
        FORMAT csv,
        DELIMITER ';',
        HEADER true
    );

-- Refurbished INSERT for empresas to handle NULL entramados
INSERT INTO
    empresas (
        nombre,
        cif_nif_nie,
        directivos,
        api,
        direccion_fiscal,
        entramado_id
    )
SELECT
    s.nombre,
    s.cif_nif_nie,
    s.directivos,
    s.api,
    s.direccion_fiscal,
    ee.id  -- This will be NULL when no entramado exists
FROM
    staging_empresas s
    LEFT JOIN entramado_empresas ee ON s.entramado = ee.nombre
ON CONFLICT (cif_nif_nie) DO NOTHING;